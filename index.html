<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Project Anvesh - Loading</title>
    <link rel="stylesheet" href="styles.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;600;700&display=swap"
      rel="stylesheet"
    />
  </head>
  <body
    class="loading-page"
    style="
      background-image: url('indexback.jpeg');
      background-size: cover;
      background-repeat: no-repeat;
      background-position: center;
    "
  >
    <div class="loading-container">
      <div class="loading-content">
        <h1 class="loading-title">PROJECT ANVESH</h1>
        <p class="loading-subtitle">Environmental Monitoring System</p>
        <div class="loader"></div>
        <p class="loading-text">Connecting to database...</p>
        <div class="loading-status" id="loadingStatus"></div>
      </div>
    </div>

    <script src="script.js"></script>
    <script type="module">
      // Import the functions you need from the SDKs you need
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
      import {
        getDatabase,
        ref,
        set,
        get,
        child,
      } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";

      // Paste the code from Firebase
      const firebaseConfig = {
    apiKey: "AIzaSyDbkgksVGEx_ayBMzQ-WRByYXjHXUuabXA",
    authDomain: "project-anvesh-248ee.firebaseapp.com",
    projectId: "project-anvesh-248ee",
    storageBucket: "project-anvesh-248ee.firebasestorage.app",
    messagingSenderId: "635289312817",
    appId: "1:635289312817:web:080a8e8278a87e95acff10",
    measurementId: "G-818RT4QC8G"
  };

      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);

      let connectionAttempts = 0;
      const maxAttempts = 5;
      const statusElement = document.getElementById("loadingStatus");

      document.addEventListener("DOMContentLoaded", function () {
        function updateStatus(message, isError = false) {
          statusElement.textContent = message;
          statusElement.className = isError
            ? "loading-status error"
            : "loading-status";
        }

        function performActions() {
          updateStatus("Connection successful! Redirecting...");
          setTimeout(() => {
            window.location.href = "home.html";
          }, 1000);
        }

        function attemptConnection() {
          connectionAttempts++;
          updateStatus(
            `Attempting connection (${connectionAttempts}/${maxAttempts})...`
          );

          const dbRef = ref(getDatabase(app));
          get(dbRef)
            .then((snapshot) => {
              if (snapshot.exists()) {
                clearInterval(interval);
                performActions();
              } else {
                updateStatus("Database is empty, but connection established.");
                setTimeout(performActions, 2000);
              }
            })
            .catch((error) => {
              console.error("Connection error:", error);

              if (connectionAttempts >= maxAttempts) {
                updateStatus(
                  "Connection failed. Please check your internet connection.",
                  true
                );
                setTimeout(() => {
                  updateStatus("Retrying connection...");
                  connectionAttempts = 0;
                }, 3000);
              } else {
                updateStatus(
                  `Connection attempt ${connectionAttempts} failed. Retrying...`,
                  true
                );
              }
            });
        }

        // Initial connection attempt
        attemptConnection();

        // Set up interval for retries
        var interval = setInterval(attemptConnection, 2000);
      });
    </script>
  </body>
</html>
