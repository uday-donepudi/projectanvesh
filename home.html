<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Project Anvesh - Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="styles.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;600;700&display=swap"
      rel="stylesheet"
    />
  </head>
  <body
    style="
      background-image: url('homeback.jpeg');
      background-size: cover;
      background-attachment: fixed;
    "
  >
    <div class="container">
      <div class="header">PROJECT ANVESH</div>

      <div class="main">
        <div class="res">
          <h3 class="section-title">Sensor Readings</h3>
          <table>
            <tr>
              <td>Color Value</td>
              <td id="color">Loading...</td>
            </tr>
            <tr>
              <td>Proximity Sensor</td>
              <td id="sens">Loading...</td>
            </tr>
            <tr>
              <td>Last Updated</td>
              <td id="lastUpdated">Never</td>
            </tr>
          </table>
        </div>
        <div class="bar">
          <div class="vertical-bar">
            
            <div class="level level1" data-level="1"></div>
            <div class="level level2" data-level="2"></div>
            <div class="level level3" data-level="3"></div>
          </div>
          <div class="des">
            <div class="status-container">
              <h3 class="section-title">Environmental Status</h3>
              <div id="desmsg">Analyzing data...</div>
              <div class="refresh-button" onclick="refreshData()">
                ðŸ”„ Refresh Data
              </div>
            </div>
          </div>
        </div>
        <div class="msg">
          <div class="notice">
            <img src="thank.jpg" alt="Environmental awareness" />
          </div>
          <div class="noticemgs">
            <div class="emoji-container">
              <p id="msgp">ðŸ”„</p>
              <p class="status-text">Analyzing...</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="form.js"></script>
    <script type="module">
      // Import the functions you need from the SDKs you need
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
      import {
        getDatabase,
        ref,
        get,
        set,
      } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";

      // Paste the code from Firebase
      const firebaseConfig = {
        apiKey: "AIzaSyDbkgksVGEx_ayBMzQ-WRByYXjHXUuabXA",
        authDomain: "project-anvesh-248ee.firebaseapp.com",
        projectId: "project-anvesh-248ee",
        storageBucket: "project-anvesh-248ee.firebasestorage.app",
        messagingSenderId: "635289312817",
        appId: "1:635289312817:web:080a8e8278a87e95acff10",
        measurementId: "G-818RT4QC8G",
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);

      let refreshInterval;

      function updateLastUpdated() {
        const now = new Date();
        document.getElementById("lastUpdated").textContent =
          now.toLocaleTimeString();
      }

      function refreshData() {
        const dbRef = ref(getDatabase(app));
        get(dbRef)
          .then((snapshot) => {
            if (snapshot.exists()) {
              const data = snapshot.val();
              const color = data.color || 0;

              // Call the fillLevels function from form.js
              if (typeof window.fillLevels === "function") {
                window.fillLevels(color);
              }
              updateLastUpdated();
            } else {
              console.log("No data available");
              document.getElementById("color").textContent = "No data";
              document.getElementById("sens").textContent = "No data";
            }
          })
          .catch((error) => {
            console.error("Error fetching data:", error);
            document.getElementById("color").textContent = "Error";
            document.getElementById("sens").textContent = "Error";
          });
      }

      function updateSensorReadings(colorValue) {
        document.getElementById("color").textContent = colorValue;

        // Calculate proximity sensor value based on color (fixed values)
        let proximityValue;
        if (colorValue <= 30) {
          proximityValue = 500;
        } else if (colorValue <= 60) {
          proximityValue = 900;
        } else {
          proximityValue = 1000;
        }

        document.getElementById("sens").textContent = proximityValue;
      }

      document.addEventListener("DOMContentLoaded", function () {
        // Initial data fetch
        refreshData();

        // Set up auto-refresh every 10 seconds
        refreshInterval = setInterval(refreshData, 10000);

        // Initial Firebase data fetch
        const dbRef = ref(getDatabase(app));
        get(dbRef)
          .then((snapshot) => {
            if (snapshot.exists()) {
              const data = snapshot.val();
              const color = data.color || 0;

              // Use the fillLevels function from form.js
              if (typeof window.fillLevels === "function") {
                window.fillLevels(color);
              }
            } else {
              console.log("No data available");
            }
          })
          .catch((error) => {
            console.error("Error in Firebase initialization:", error);
          });
      });
    </script>
  </body>
</html>
